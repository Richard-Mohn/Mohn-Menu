rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // ─── Helper Functions ──────────────────────────────────────
    function isAuthenticated() {
      return request.auth != null;
    }

    function isUser(userId) {
      return isAuthenticated() && request.auth.uid == userId;
    }

    function getUserData() {
      return get(/databases/$(database)/documents/users/$(request.auth.uid)).data;
    }

    function isBusinessOwner(businessId) {
      return isAuthenticated() && 
        get(/databases/$(database)/documents/businesses/$(businessId)).data.ownerId == request.auth.uid;
    }

    function belongsToBusiness(businessId) {
      return isAuthenticated() &&
        businessId in getUserData().businessIds;
    }

    function isBusinessMember(businessId) {
      return isBusinessOwner(businessId) || belongsToBusiness(businessId);
    }

    // ─── Users Collection ──────────────────────────────────────
    // Users can only read/write their own document
    match /users/{userId} {
      allow read: if isUser(userId);
      allow create: if isUser(userId);
      allow update: if isUser(userId);
      allow delete: if false;
    }

    // Owner can list users that belong to their business
    match /users/{userId} {
      allow read: if isAuthenticated() && 
        getUserData().role == 'owner' &&
        resource.data.businessIds.hasAny(getUserData().businessIds);
    }

    // ─── Businesses Collection ─────────────────────────────────
    // Public read (needed for SEO websites and slug resolution)
    // Only owner can write
    match /businesses/{businessId} {
      allow read: if true;
      allow create: if isAuthenticated();
      allow update: if isBusinessOwner(businessId);
      allow delete: if false;

      // ─── Bookings Subcollection (legacy) ─────────────────
      // Public create (anyone can place a booking)
      // Business members can read
      match /bookings/{bookingId} {
        allow create: if true;
        allow read: if isBusinessMember(businessId);
        allow update: if isBusinessMember(businessId);
        allow delete: if isBusinessOwner(businessId);
      }

      // ─── Menu Items Subcollection ─────────────────────────
      // Public read (customers need to see the menu)
      // Only owner/manager can write
      match /menuItems/{itemId} {
        allow read: if true;
        allow create: if isBusinessOwner(businessId);
        allow update: if isBusinessMember(businessId);
        allow delete: if isBusinessOwner(businessId);
      }

      // ─── Orders Subcollection ─────────────────────────────
      // Public create (anyone can place an order from the menu)
      // Business members can read/update (manage orders)
      // Customers can read their own orders
      match /orders/{orderId} {
        allow create: if true;
        allow read: if isBusinessMember(businessId) ||
          (isAuthenticated() && resource.data.customerId == request.auth.uid);
        allow update: if isBusinessMember(businessId);
        allow delete: if false;
      }

      // ─── Driver Locations Subcollection ────────────────────
      // Only the driver themselves can write their GPS
      match /driverLocations/{driverId} {
        allow read: if isBusinessMember(businessId);
        allow write: if isUser(driverId) && belongsToBusiness(businessId);
      }

      // ─── Invite Codes Subcollection ────────────────────────
      // Public read (for driver/staff signup), owner write
      match /inviteCodes/{codeId} {
        allow read: if true;
        allow write: if isBusinessOwner(businessId);
      }
    }

    // ─── Platform Collection ───────────────────────────────────
    // Public read, admin SDK write only
    match /platform/{document=**} {
      allow read: if true;
      allow write: if false;
    }
  }
}